create database hostel;

--Hostel Database
use hostel;


--Blocks Table
create table blocks (
	block_id bigint auto_increment primary key,
    previous_hash varchar(255),
    block_hash varchar(255) not null,
    timestamp datetime default current_timestamp,
    nonce bigint,
    merkle_root varchar(255),
    created_by varchar(50),
    status enum('Active', 'Archived') default 'Active',
    json_log_path text,
    unique (block_hash)
);


--Transactions Table
create table transactions (
	txn_id bigint auto_increment primary key,
    complaint_id bigint,
    user_id varchar(50),
    action enum('Raised', 'Assigned', 'In Progress', 'Resolved', 'Closed', 'Escalated', 'Priority Updated'),
    description text,
    timestamp datetime default current_timestamp,
    transaction_hash varchar(255) not null,
    block_id bigint,
    json_data json,
    foreign key (complaint_id) references complaints(id),
    foreign key (user_id) references users(user_id),
    foreign key (block_id) references blocks(block_id),
    unique (transaction_hash)
);


--Blockchain Metadata Table
create table blockchain_metadata (
	id int primary key,
    chain_length int,
    last_block_hash varchar(255),
    difficulty int,
    last_updated datetime,
    status enum ('Active', 'Corrupted', 'Syncing')
);


--Users Table
create table users(
	user_id varchar(20) not null primary key,
	email varchar(255) not null unique,
    name varchar(255) not null,
    password varchar(255) not null,
    role enum('Admin', 'Staff', 'Student', 'Warden') not null,
    room_number varchar(255),
    password_reset_token varchar(255),
    password_reset_token_expiry datetime(6),
    created_at datetime(6) default current_timestamp(6),
    updated_at datetime(6) default current_timestamp(6) on update current_timestamp(6)
);


--Complaints Table
create table complaints(
	id bigint not null auto_increment primary key,
    category varchar(255) not null,
    created_at datetime(6) default current_timestamp(6),
    description varchar(1000) not null,
    feedback varchar(500),
    priority tinyint,
    rating int,
    status enum('Raised', 'In Progress', 'Resolved', 'Closed') not null,
    staff_id varchar(20),
    student_id varchar(20),
    room_number varchar(255),
    assigned_to varchar(255),
    foreign key (staff_id) references users(user_id),
    foreign key (student_id) references users(user_id)
);   
